name: Restrict student commits

on: [push, pull_request]

jobs:
  check-paths:
    name: ğŸ”’ Restrict student commits
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© Repository auschecken (vollstÃ¤ndig)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ©º Diagnose â€“ zeigt Locale und Git-Version
      - name: Check runner environment
        run: |
          echo "ğŸŒ Aktuelle Locale:"
          locale
          echo
          echo "ğŸ’» Git-Version:"
          git --version
          echo
          echo "ğŸ”¤ Encoding-Test:"
          echo "Ãœbung_Ã„rger_Ã–konom.py"
          echo

      # âœ… HauptprÃ¼fung
      - name: Verify changed file paths
        run: |
          # --- UTF-8-Locale aktivieren ---
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          echo "ğŸ‘¤ Benutzer: ${{ github.actor }}"
          echo "ğŸ” Branch:  ${{ github.ref_name }}"
          echo

          # --- Commit-Vergleich bestimmen ---
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            echo "â„¹ï¸ Neuer Branch oder erster Commit â€“ prÃ¼fe nur neue Dateien."
            CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi

          echo "ğŸ“„ GeÃ¤nderte / hinzugefÃ¼gte Dateien:"
          echo "$CHANGED"
          echo

          # Wenn nichts geÃ¤ndert wurde, ist alles gut
          if [ -z "$CHANGED" ]; then
            echo "âœ… Keine geÃ¤nderten Dateien gefunden."
            exit 0
          fi

          # --- Lehrer-Ausnahme ---
          if [ "${{ github.actor }}" = "BerndDonner" ]; then
            echo "ğŸ§‘â€ğŸ« Lehrer erkannt â€“ keine PfadprÃ¼fung erforderlich."
            exit 0
          fi

          # --- Actor-Namen exakt wie GitHub-Login verwenden ---
          actor="${{ github.actor }}"
          echo "ğŸ‘¤ Erwarteter Benutzer-Ordner: ${actor}/"
          echo

          # --- Optional: Gemeinsame Verzeichnisse erlauben ---
          # Hier kannst du beliebige Pfade hinzufÃ¼gen, die alle Ã¤ndern dÃ¼rfen
          # ^...   = nur am Anfang der Zeile
          # actor/ = persÃ¶nlicher Ordner
          # common/, shared/ = gemeinsame Ordner
          # README.md = global erlaubt
          # $        = Leerzeilen (zur Sicherheit)
          allowed_prefixes="^(${actor}/|common/|shared/|README\.md|$)"

          echo "ğŸ§© Erlaubte Pfad-PrÃ¤fixe (Regex): $allowed_prefixes"
          echo

          # --- PrÃ¼fen auf VerstÃ¶ÃŸe ---
          # grep -E  = regulÃ¤rer Ausdruck
          # -v       = alles, was NICHT passt
          # || true  = Fehlercode von grep ignorieren, wenn nichts gefunden
          violations=$(echo "$CHANGED" | grep -Ev "$allowed_prefixes" || true)

          if [ -n "$violations" ]; then
            echo "âŒ Commit enthÃ¤lt Dateien auÃŸerhalb deines Verzeichnisses!"
            echo "ğŸ‘¤ Erlaubt ist nur: ${actor}/ (plus ggf. common/, shared/, README.md)"
            echo "ğŸš« Nicht erlaubte Dateien:"
            echo "$violations"
            echo
            echo "ğŸ’¡ Hinweis: Benenne dein persÃ¶nliches Verzeichnis exakt wie dein GitHub-Login (${actor})"
            exit 1
          fi

          echo "âœ… Alle Ã„nderungen befinden sich im erlaubten Bereich (${actor}/ oder gemeinsame Bereiche)."
