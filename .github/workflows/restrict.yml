name: Restrict student commits

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      from_sha:
        description: 'Optional: Basis-Commit f√ºr den Vergleich (Standard: HEAD^)'
        required: false
      to_sha:
        description: 'Optional: Ziel-Commit f√ºr den Vergleich (Standard: HEAD)'
        required: false
      actor:
        description: 'Optional: GitHub-Login, der gepr√ºft werden soll (√ºberschreibt github.actor)'
        required: false

jobs:
  check-paths:
    name: üîí Restrict student commits
    runs-on: ubuntu-latest

    steps:
      # üß© Repository auschecken (vollst√§ndig)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ü©∫ Diagnose ‚Äì zeigt Locale und Git-Version
      - name: Check runner environment
        run: |
          echo "üåç Aktuelle Locale:"
          locale
          echo
          echo "üíª Git-Version:"
          git --version
          echo
          echo "üî§ Encoding-Test:"
          echo "√úbung_√Ñrger_√ñkonom.py"
          echo

      # ‚úÖ Hauptpr√ºfung
      - name: Verify changed file paths
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          EVENT_BEFORE: ${{ github.event.before }}
          EVENT_SHA: ${{ github.sha }}
          INPUT_FROM_SHA: ${{ inputs.from_sha }}
          INPUT_TO_SHA: ${{ inputs.to_sha }}
          INPUT_ACTOR: ${{ inputs.actor }}
        run: |
          # --- UTF-8-Locale aktivieren ---
          export LANG=C.UTF-8
          export LC_ALL=C.UTF-8

          echo "üë§ Benutzer (github.actor): $GITHUB_ACTOR"
          echo "üîç Branch:  $GITHUB_REF_NAME"
          echo "üì¶ Event:   $GITHUB_EVENT_NAME"
          echo

          # --- Commit-Vergleich bestimmen ---
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            FROM="$INPUT_FROM_SHA"
            TO="$INPUT_TO_SHA"

            # Standard: Vergleich HEAD^ -> HEAD
            if [ -z "$TO" ]; then
              TO="HEAD"
            fi
            if [ -z "$FROM" ]; then
              FROM="${TO}^"
            fi

            echo "‚ÑπÔ∏è workflow_dispatch: pr√ºfe Diff von $FROM bis $TO"
            CHANGED=$(git diff --name-only "$FROM" "$TO")
          else
            if [ "$EVENT_BEFORE" = "0000000000000000000000000000000000000000" ]; then
              echo "‚ÑπÔ∏è Neuer Branch oder erster Commit ‚Äì pr√ºfe nur neue Dateien (HEAD)."
              CHANGED=$(git diff-tree --no-commit-id --name-only -r "$EVENT_SHA")
            else
              echo "‚ÑπÔ∏è Pr√ºfe Diff von $EVENT_BEFORE bis $EVENT_SHA"
              CHANGED=$(git diff --name-only "$EVENT_BEFORE" "$EVENT_SHA")
            fi
          fi

          echo "üìÑ Ge√§nderte / hinzugef√ºgte Dateien:"
          echo "$CHANGED"
          echo

          # Wenn nichts ge√§ndert wurde, ist alles gut
          if [ -z "$CHANGED" ]; then
            echo "‚úÖ Keine ge√§nderten Dateien gefunden."
            exit 0
          fi

          # --- Actor bestimmen (ggf. Override bei workflow_dispatch) ---
          actor="$GITHUB_ACTOR"
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ] && [ -n "$INPUT_ACTOR" ]; then
            echo "‚ÑπÔ∏è Actor-Override aktiv: $INPUT_ACTOR"
            actor="$INPUT_ACTOR"
          fi

          # --- Lehrer-Ausnahme ---
          if [ "$actor" = "BerndDonner" ]; then
            echo "üßë‚Äçüè´ Lehrer erkannt ‚Äì keine Pfadpr√ºfung erforderlich."
            exit 0
          fi

          # --- Actor-Ordner / erlaubte Pfade ---
          echo "üë§ Erwarteter Benutzer-Ordner: ${actor}/"
          echo

          # ^...   = nur am Anfang der Zeile
          # actor/ = pers√∂nlicher Ordner
          # common/, shared/ = gemeinsame Ordner
          # README.md = global erlaubt
          # $        = Leerzeilen (zur Sicherheit)
          allowed_prefixes="^(${actor}/|common/|shared/|README\.md|$)"

          echo "üß© Erlaubte Pfad-Pr√§fixe (Regex): $allowed_prefixes"
          echo

          # --- Pr√ºfen auf Verst√∂√üe ---
          # grep -E  = regul√§rer Ausdruck
          # -v       = alles, was NICHT passt
          # || true  = Fehlercode von grep ignorieren, wenn nichts gefunden
          violations=$(echo "$CHANGED" | grep -Ev "$allowed_prefixes" || true)

          if [ -n "$violations" ]; then
            echo "‚ùå Commit enth√§lt Dateien au√üerhalb deines Verzeichnisses!"
            echo "üë§ Erlaubt ist nur: ${actor}/ (plus ggf. common/, shared/, README.md)"
            echo "üö´ Nicht erlaubte Dateien:"
            echo "$violations"
            echo
            echo "üí° Hinweis: Benenne dein pers√∂nliches Verzeichnis exakt wie dein GitHub-Login (${actor})"
            exit 1
          fi

          echo "‚úÖ Alle √Ñnderungen befinden sich im erlaubten Bereich (${actor}/ oder gemeinsame Bereiche)."
